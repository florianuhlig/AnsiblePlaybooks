---
# Playbook: reboot-hosts.yml
# Description: Reboots hosts and waits for them to come back online
# Usage: ansible-playbook playbooks/reboot-hosts.yml
# Note: Use --limit to target specific hosts (e.g., --limit webservers)

- name: Reboot hosts and verify connectivity
  hosts: all
  gather_facts: true
  become: true

  tasks:
    - name: Display pre-reboot information
      ansible.builtin.debug:
        msg: "Rebooting {{ inventory_hostname }} (uptime: {{ ansible_uptime_seconds | int // 86400 }} days)"

    - name: Reboot the host
      ansible.builtin.reboot:
        reboot_timeout: 600
        pre_reboot_delay: 5
        post_reboot_delay: 30
        msg: "Reboot initiated by Ansible"

    - name: Wait for host to be reachable
      ansible.builtin.wait_for_connection:
        delay: 10
        timeout: 300

    - name: Gather facts after reboot
      ansible.builtin.setup:
        gather_subset:
          - min

    - name: Verify host is back online
      ansible.builtin.debug:
        msg:
          - "Host {{ inventory_hostname }} successfully rebooted"
          - "New uptime: {{ ansible_uptime_seconds }} seconds"
          - "Kernel: {{ ansible_kernel }}"
