---
# Playbook: check-open-ports.yml
# Description: Scans all servers for open TCP ports and generates a report
# Usage: ansible-playbook playbooks/check-open-ports.yml
# Requirements: ss or netstat must be available on target hosts

- name: Check open ports on all servers
  hosts: all
  gather_facts: true

  vars:
    output_dir: "{{ output_dir | default('/mnt/backup.fuhlig.de/automation/OpenPorts') }}"

  tasks:
    - name: Check if ss command is available
      ansible.builtin.command: which ss
      register: ss_check
      changed_when: false
      failed_when: false

    - name: Check if netstat command is available
      ansible.builtin.command: which netstat
      register: netstat_check
      changed_when: false
      failed_when: false
      when: ss_check.rc != 0

    - name: Get open ports using ss (preferred)
      ansible.builtin.shell: |
        set -o pipefail
        ss -tlnp 2>/dev/null | tail -n +2 | awk '{print $4}' | sed 's/.*://' | sort -n | uniq
      args:
        executable: /bin/bash
      register: open_ports_ss
      changed_when: false
      when: ss_check.rc == 0

    - name: Get open ports using netstat (fallback)
      ansible.builtin.shell: |
        set -o pipefail
        netstat -tlnp 2>/dev/null | tail -n +3 | awk '{print $4}' | sed 's/.*://' | sort -n | uniq
      args:
        executable: /bin/bash
      register: open_ports_netstat
      changed_when: false
      when: ss_check.rc != 0 and netstat_check.rc == 0

    - name: Get detailed port information using ss
      ansible.builtin.shell: |
        set -o pipefail
        ss -tlnp 2>/dev/null | tail -n +2 | awk '{
          split($4, addr, ":");
          port = addr[length(addr)];
          gsub(/users:\(\("|"\)\)/, "", $6);
          gsub(/,pid=[0-9]+,fd=[0-9]+\)/, "", $6);
          gsub(/\(/, "", $6);
          print port "\t" $4 "\t" $6
        }' | sort -t$'\t' -k1 -n | uniq
      args:
        executable: /bin/bash
      register: port_details_ss
      changed_when: false
      when: ss_check.rc == 0

    - name: Get detailed port information using netstat
      ansible.builtin.shell: |
        set -o pipefail
        netstat -tlnp 2>/dev/null | tail -n +3 | awk '{
          split($4, addr, ":");
          port = addr[length(addr)];
          print port "\t" $4 "\t" $7
        }' | sort -t$'\t' -k1 -n | uniq
      args:
        executable: /bin/bash
      register: port_details_netstat
      changed_when: false
      when: ss_check.rc != 0 and netstat_check.rc == 0

    - name: Set open ports fact
      ansible.builtin.set_fact:
        open_ports: "{{ (open_ports_ss.stdout_lines | default(open_ports_netstat.stdout_lines | default([]))) }}"
        port_details: "{{ (port_details_ss.stdout | default(port_details_netstat.stdout | default(''))) }}"

    - name: Get UDP open ports using ss
      ansible.builtin.shell: |
        set -o pipefail
        ss -ulnp 2>/dev/null | tail -n +2 | awk '{
          split($4, addr, ":");
          port = addr[length(addr)];
          gsub(/users:\(\("|"\)\)/, "", $6);
          gsub(/,pid=[0-9]+,fd=[0-9]+\)/, "", $6);
          gsub(/\(/, "", $6);
          print port "\t" $4 "\t" $6
        }' | sort -t$'\t' -k1 -n | uniq
      args:
        executable: /bin/bash
      register: udp_ports_ss
      changed_when: false
      when: ss_check.rc == 0

    - name: Get UDP open ports using netstat
      ansible.builtin.shell: |
        set -o pipefail
        netstat -ulnp 2>/dev/null | tail -n +3 | awk '{
          split($4, addr, ":");
          port = addr[length(addr)];
          print port "\t" $4 "\t" $7
        }' | sort -t$'\t' -k1 -n | uniq
      args:
        executable: /bin/bash
      register: udp_ports_netstat
      changed_when: false
      when: ss_check.rc != 0 and netstat_check.rc == 0

    - name: Set UDP ports fact
      ansible.builtin.set_fact:
        udp_port_details: "{{ (udp_ports_ss.stdout | default(udp_ports_netstat.stdout | default(''))) }}"

    - name: Create output directory
      ansible.builtin.file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true

    - name: Prepare ports report data
      ansible.builtin.set_fact:
        ports_report:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          host: "{{ inventory_hostname }}"
          ip_address: "{{ ansible_default_ipv4.address | default(ansible_all_ipv4_addresses[0] | default('unknown')) }}"
          os_family: "{{ ansible_os_family }}"
          os_distribution: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          scan_tool: "{{ 'ss' if ss_check.rc == 0 else 'netstat' }}"
          total_tcp_ports: "{{ open_ports | length }}"
          tcp_ports: "{{ open_ports }}"
          tcp_details: "{{ port_details }}"
          udp_details: "{{ udp_port_details }}"

    - name: Export ports report to JSON
      ansible.builtin.copy:
        content: "{{ ports_report | to_nice_json }}"
        dest: "{{ output_dir }}/open-ports-{{ inventory_hostname }}.json"
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        mode: '0644'
      delegate_to: localhost

    - name: Display ports summary
      ansible.builtin.debug:
        msg:
          - "==========================================="
          - "Open Ports Report: {{ inventory_hostname }}"
          - "==========================================="
          - "IP Address: {{ ansible_default_ipv4.address | default('N/A') }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - ""
          - "TCP Listening Ports ({{ open_ports | length }} total):"
          - "Port    Address                 Process"
          - "-------------------------------------------"
          - "{{ port_details }}"
          - ""
          - "UDP Listening Ports:"
          - "Port    Address                 Process"
          - "-------------------------------------------"
          - "{{ udp_port_details }}"
          - ""
          - "Report saved to: {{ output_dir }}/open-ports-{{ inventory_hostname }}.json"
