---
# Playbook: export-firewall.yml
# Description: Exports iptables and ip6tables rules to Markdown format
# Usage: ansible-playbook playbooks/export-firewall.yml

- name: Export iptables and ip6tables rules
  hosts: all
  gather_facts: true
  become: true

  vars:
    output_directory: "{{ output_dir | default('/mnt/storage/Obsidian/Documentation/Hosting/Firewall') }}"
    file_owner: "{{ owner | default('fuhlig') }}"
    ssh_key_path: "{{ git_ssh_key | default('/home/semaphore/.ssh/id_rsa') }}"

  tasks:
    - name: Gather iptables rules (IPv4)
      ansible.builtin.shell: iptables-save
      register: iptables_output
      changed_when: false

    - name: Gather ip6tables rules (IPv6)
      ansible.builtin.shell: ip6tables-save
      register: ip6tables_output
      changed_when: false

    - name: Create output directory
      ansible.builtin.file:
        path: "{{ output_directory }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      run_once: true

    - name: Export firewall rules to Markdown file
      ansible.builtin.copy:
        content: |
          ## System Information

          | Property | Value |
          |----------|-------|
          | Hostname | {{ inventory_hostname }} |
          | OS | {{ ansible_distribution }} {{ ansible_distribution_version }} |
          | Timestamp | {{ ansible_date_time.iso8601 }} |

          ## IPv4 Rules (iptables)

          ```
          {{ iptables_output.stdout }}
          ```

          ## IPv6 Rules (ip6tables)

          ```
          {{ ip6tables_output.stdout }}
          ```
        dest: "{{ output_directory }}/{{ inventory_hostname }}.md"
        owner: "{{ file_owner }}"
        group: "{{ file_owner }}"
        mode: "0644"
      delegate_to: localhost

    - name: Configure git user
      ansible.builtin.shell: |
        git config user.name "florianuhlig"
        git config user.email "fuh@fuhlig.de"
      args:
        chdir: "{{ output_directory }}"
      delegate_to: localhost
      run_once: true

    - name: Add, commit, and push changes
      ansible.builtin.shell: |
        git add -A
        git commit -m "Automated firewall export: {{ ansible_date_time.date }}"
        git push origin main
      args:
        chdir: "{{ output_directory }}"
      environment:
        GIT_SSH_COMMAND: "ssh -i {{ ssh_key_path }} -o StrictHostKeyChecking=accept-new"
      register: git_result
      delegate_to: localhost
      run_once: true

    - name: Show git output
      ansible.builtin.debug:
        var: git_result.stdout
      run_once: true
