---
# Playbook: export-iptables.yml
# Description: Exports all iptables rules and ipsets from remote hosts
# Usage: ansible-playbook playbooks/export-iptables.yml

- name: Export Iptables Rules and IPsets
  hosts: all
  gather_facts: true
  become: true

  vars:
    export_date: "{{ ansible_date_time.date }}"
    export_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
    output_directory: "{{ output_dir | default('/mnt/storage/Audit/Iptables') }}"
    output_owner: "{{ lookup('env', 'USER') | default('root') }}"
    output_group: "{{ lookup('env', 'USER') | default('root') }}"

  tasks:
    # =========================================================================
    # Check for iptables
    # =========================================================================
    - name: Check if iptables is available
      ansible.builtin.command: which iptables
      register: iptables_check
      changed_when: false
      failed_when: false

    - name: Check if ip6tables is available
      ansible.builtin.command: which ip6tables
      register: ip6tables_check
      changed_when: false
      failed_when: false

    - name: Check if ipset is available
      ansible.builtin.command: which ipset
      register: ipset_check
      changed_when: false
      failed_when: false

    # =========================================================================
    # Export IPv4 iptables rules
    # =========================================================================
    - name: Export iptables rules (all tables)
      ansible.builtin.shell: |
        set -o pipefail
        for table in filter nat mangle raw security; do
          echo "# Table: $table"
          iptables -t $table -S 2>/dev/null || echo "# Table $table not available"
          echo ""
        done
      args:
        executable: /bin/bash
      register: iptables_rules
      changed_when: false
      failed_when: false
      when: iptables_check.rc == 0

    - name: Export iptables rules with counters (verbose)
      ansible.builtin.shell: |
        set -o pipefail
        for table in filter nat mangle raw security; do
          echo "# Table: $table"
          iptables -t $table -L -n -v --line-numbers 2>/dev/null || echo "# Table $table not available"
          echo ""
        done
      args:
        executable: /bin/bash
      register: iptables_verbose
      changed_when: false
      failed_when: false
      when: iptables_check.rc == 0

    - name: Export iptables-save format
      ansible.builtin.command: iptables-save
      register: iptables_save
      changed_when: false
      failed_when: false
      when: iptables_check.rc == 0

    # =========================================================================
    # Export IPv6 ip6tables rules
    # =========================================================================
    - name: Export ip6tables rules (all tables)
      ansible.builtin.shell: |
        set -o pipefail
        for table in filter nat mangle raw security; do
          echo "# Table: $table"
          ip6tables -t $table -S 2>/dev/null || echo "# Table $table not available"
          echo ""
        done
      args:
        executable: /bin/bash
      register: ip6tables_rules
      changed_when: false
      failed_when: false
      when: ip6tables_check.rc == 0

    - name: Export ip6tables rules with counters (verbose)
      ansible.builtin.shell: |
        set -o pipefail
        for table in filter nat mangle raw security; do
          echo "# Table: $table"
          ip6tables -t $table -L -n -v --line-numbers 2>/dev/null || echo "# Table $table not available"
          echo ""
        done
      args:
        executable: /bin/bash
      register: ip6tables_verbose
      changed_when: false
      failed_when: false
      when: ip6tables_check.rc == 0

    - name: Export ip6tables-save format
      ansible.builtin.command: ip6tables-save
      register: ip6tables_save
      changed_when: false
      failed_when: false
      when: ip6tables_check.rc == 0

    # =========================================================================
    # Export IPsets
    # =========================================================================
    - name: List all ipsets
      ansible.builtin.command: ipset list -n
      register: ipset_list
      changed_when: false
      failed_when: false
      when: ipset_check.rc == 0

    - name: Export ipset details
      ansible.builtin.command: ipset list
      register: ipset_details
      changed_when: false
      failed_when: false
      when: ipset_check.rc == 0

    - name: Export ipset save format (restorable)
      ansible.builtin.command: ipset save
      register: ipset_save
      changed_when: false
      failed_when: false
      when: ipset_check.rc == 0

    # =========================================================================
    # Create output directory
    # =========================================================================
    - name: Create output directory
      ansible.builtin.file:
        path: "{{ output_directory }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true

    - name: Create host-specific output directory
      ansible.builtin.file:
        path: "{{ output_directory }}/{{ inventory_hostname }}"
        state: directory
        mode: '0755'
      delegate_to: localhost

    # =========================================================================
    # Save iptables exports
    # =========================================================================
    - name: Save iptables rules
      ansible.builtin.copy:
        content: |
          # Iptables Rules Export
          # Host: {{ inventory_hostname }}
          # Date: {{ export_date }}
          # Generated by Ansible

          {{ iptables_rules.stdout | default('# No iptables rules available') }}
        dest: "{{ output_directory }}/{{ inventory_hostname }}/iptables-rules-{{ export_date }}.txt"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost
      when: iptables_check.rc == 0

    - name: Save iptables verbose output
      ansible.builtin.copy:
        content: |
          # Iptables Verbose Export (with counters)
          # Host: {{ inventory_hostname }}
          # Date: {{ export_date }}
          # Generated by Ansible

          {{ iptables_verbose.stdout | default('# No iptables rules available') }}
        dest: "{{ output_directory }}/{{ inventory_hostname }}/iptables-verbose-{{ export_date }}.txt"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost
      when: iptables_check.rc == 0

    - name: Save iptables-save output (restorable format)
      ansible.builtin.copy:
        content: "{{ iptables_save.stdout | default('# No iptables rules available') }}"
        dest: "{{ output_directory }}/{{ inventory_hostname }}/iptables-save-{{ export_date }}.rules"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost
      when: iptables_check.rc == 0

    # =========================================================================
    # Save ip6tables exports
    # =========================================================================
    - name: Save ip6tables rules
      ansible.builtin.copy:
        content: |
          # Ip6tables Rules Export
          # Host: {{ inventory_hostname }}
          # Date: {{ export_date }}
          # Generated by Ansible

          {{ ip6tables_rules.stdout | default('# No ip6tables rules available') }}
        dest: "{{ output_directory }}/{{ inventory_hostname }}/ip6tables-rules-{{ export_date }}.txt"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost
      when: ip6tables_check.rc == 0

    - name: Save ip6tables verbose output
      ansible.builtin.copy:
        content: |
          # Ip6tables Verbose Export (with counters)
          # Host: {{ inventory_hostname }}
          # Date: {{ export_date }}
          # Generated by Ansible

          {{ ip6tables_verbose.stdout | default('# No ip6tables rules available') }}
        dest: "{{ output_directory }}/{{ inventory_hostname }}/ip6tables-verbose-{{ export_date }}.txt"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost
      when: ip6tables_check.rc == 0

    - name: Save ip6tables-save output (restorable format)
      ansible.builtin.copy:
        content: "{{ ip6tables_save.stdout | default('# No ip6tables rules available') }}"
        dest: "{{ output_directory }}/{{ inventory_hostname }}/ip6tables-save-{{ export_date }}.rules"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost
      when: ip6tables_check.rc == 0

    # =========================================================================
    # Save IPset exports
    # =========================================================================
    - name: Save ipset list
      ansible.builtin.copy:
        content: |
          # IPset List Export
          # Host: {{ inventory_hostname }}
          # Date: {{ export_date }}
          # Generated by Ansible

          {{ ipset_details.stdout | default('# No ipsets available') }}
        dest: "{{ output_directory }}/{{ inventory_hostname }}/ipset-list-{{ export_date }}.txt"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost
      when: ipset_check.rc == 0

    - name: Save ipset save output (restorable format)
      ansible.builtin.copy:
        content: "{{ ipset_save.stdout | default('# No ipsets available') }}"
        dest: "{{ output_directory }}/{{ inventory_hostname }}/ipset-save-{{ export_date }}.rules"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost
      when: ipset_check.rc == 0

    # =========================================================================
    # Export combined JSON report
    # =========================================================================
    - name: Compile firewall export report
      ansible.builtin.set_fact:
        firewall_report:
          export_timestamp: "{{ export_date }}"
          hostname: "{{ inventory_hostname }}"
          iptables:
            available: "{{ iptables_check.rc == 0 }}"
            rules: "{{ iptables_rules.stdout_lines | default([]) }}"
            save_format: "{{ iptables_save.stdout_lines | default([]) }}"
          ip6tables:
            available: "{{ ip6tables_check.rc == 0 }}"
            rules: "{{ ip6tables_rules.stdout_lines | default([]) }}"
            save_format: "{{ ip6tables_save.stdout_lines | default([]) }}"
          ipset:
            available: "{{ ipset_check.rc == 0 }}"
            sets: "{{ ipset_list.stdout_lines | default([]) }}"
            details: "{{ ipset_details.stdout_lines | default([]) }}"
            save_format: "{{ ipset_save.stdout_lines | default([]) }}"

    - name: Export firewall report to JSON
      ansible.builtin.copy:
        content: "{{ firewall_report | to_nice_json }}"
        dest: "{{ output_directory }}/{{ inventory_hostname }}/firewall-export-{{ export_date }}.json"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost

    # =========================================================================
    # Display Summary
    # =========================================================================
    - name: Display export summary
      ansible.builtin.debug:
        msg:
          - "==========================================="
          - "    FIREWALL EXPORT SUMMARY"
          - "    {{ export_date }}"
          - "==========================================="
          - ""
          - "HOST: {{ inventory_hostname }}"
          - "-------------------------------------------"
          - ""
          - "IPTABLES (IPv4)"
          - "  Available:    {{ 'Yes' if iptables_check.rc == 0 else 'No' }}"
          - "  Rules count:  {{ iptables_rules.stdout_lines | default([]) | length }}"
          - ""
          - "IP6TABLES (IPv6)"
          - "  Available:    {{ 'Yes' if ip6tables_check.rc == 0 else 'No' }}"
          - "  Rules count:  {{ ip6tables_rules.stdout_lines | default([]) | length }}"
          - ""
          - "IPSET"
          - "  Available:    {{ 'Yes' if ipset_check.rc == 0 else 'No' }}"
          - "  Sets count:   {{ ipset_list.stdout_lines | default([]) | length }}"
          - ""
          - "OUTPUT FILES"
          - "  Directory:    {{ output_directory }}/{{ inventory_hostname }}/"
          - "  - iptables-rules-{{ export_date }}.txt"
          - "  - iptables-verbose-{{ export_date }}.txt"
          - "  - iptables-save-{{ export_date }}.rules (restorable)"
          - "  - ip6tables-rules-{{ export_date }}.txt"
          - "  - ip6tables-verbose-{{ export_date }}.txt"
          - "  - ip6tables-save-{{ export_date }}.rules (restorable)"
          - "  - ipset-list-{{ export_date }}.txt"
          - "  - ipset-save-{{ export_date }}.rules (restorable)"
          - "  - firewall-export-{{ export_date }}.json"
          - ""
          - "==========================================="
