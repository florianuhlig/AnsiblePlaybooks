---
- name: Gather installed packages and export to JSON
  hosts: all
  gather_facts: yes

  tasks:
    - name: Gather package facts
      ansible.builtin.package_facts:
        manager: auto
      register: package_facts

    - name: Create output directory
      ansible.builtin.file:
        path: "output"
        state: directory
      delegate_to: localhost
      run_once: yes

    - name: Prepare packages data for JSON export
      ansible.builtin.set_fact:
        packages_data:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          host: "{{ inventory_hostname }}"
          os_family: "{{ ansible_os_family }}"
          os_name: "{{ ansible_distribution }}"
          os_version: "{{ ansible_distribution_version }}"
          package_count: "{{ ansible_facts.packages | length }}"
          packages: "{{ ansible_facts.packages }}"

    - name: Export packages to JSON file
      ansible.builtin.copy:
        content: "{{ packages_data | to_nice_json }}"
        dest: "output/packages-{{ inventory_hostname }}.json"
        owner: "fuhlig"
        group: "fuhlig"
        mode: '0644'
      delegate_to: localhost

    - name: Display export summary
      ansible.builtin.debug:
        msg:
          - "âœ“ Packages exported successfully"
          - "Hostname: {{ inventory_hostname }}"
          - "Total packages: {{ ansible_facts.packages | length }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "File: output/packages-{{ inventory_hostname }}.json"
