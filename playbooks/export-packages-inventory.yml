---
# Playbook: export-packages-inventory.yml
# Description: Gathers installed packages and exports them to JSON format
# Usage: ansible-playbook playbooks/export-packages-inventory.yml

- name: Export installed packages inventory to JSON
  hosts: all
  gather_facts: true

  vars:
    output_directory: "{{ playbook_dir }}/output"
    output_owner: "{{ lookup('env', 'USER') | default('root') }}"
    output_group: "{{ lookup('env', 'USER') | default('root') }}"

  tasks:
    - name: Gather package facts from host
      ansible.builtin.package_facts:
        manager: auto
      register: package_facts_result

    - name: Create output directory
      ansible.builtin.file:
        path: "{{ output_directory }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true

    - name: Prepare packages data for JSON export
      ansible.builtin.set_fact:
        packages_data:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          host: "{{ inventory_hostname }}"
          os_family: "{{ ansible_os_family }}"
          os_name: "{{ ansible_distribution }}"
          os_version: "{{ ansible_distribution_version }}"
          package_count: "{{ ansible_facts.packages | length }}"
          packages: "{{ ansible_facts.packages }}"

    - name: Export packages to JSON file
      ansible.builtin.copy:
        content: "{{ packages_data | to_nice_json }}"
        dest: "{{ output_directory }}/packages-{{ inventory_hostname }}.json"
        owner: "{{ output_owner }}"
        group: "{{ output_group }}"
        mode: '0644'
      delegate_to: localhost

    - name: Display export summary
      ansible.builtin.debug:
        msg:
          - "Packages exported successfully"
          - "Hostname: {{ inventory_hostname }}"
          - "Total packages: {{ ansible_facts.packages | length }}"
          - "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "File: {{ output_directory }}/packages-{{ inventory_hostname }}.json"
