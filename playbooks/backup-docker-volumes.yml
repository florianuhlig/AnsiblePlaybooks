---
# Playbook: backup-docker-volumes.yml
# Description: Backs up all Docker volumes to compressed tar archives
# Usage: ansible-playbook playbooks/backup-docker-volumes.yml
# Optional: -e "backup_dir=/custom/path" to specify backup directory
# Optional: -e "exclude_volumes=['volume1','volume2']" to exclude specific volumes

- name: Backup Docker volumes
  hosts: all
  gather_facts: true

  vars:
    backup_base_dir: "{{ backup_dir | default('/mnt/backup.fuhlig.de/docker_volumes') }}"
    volumes_to_exclude: "{{ exclude_volumes | default([]) }}"
    timestamp: "{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}"

  tasks:
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_version_check
      changed_when: false
      failed_when: false

    - name: Skip host if Docker is not installed
      ansible.builtin.meta: end_host
      when: docker_version_check.rc != 0

    - name: Get list of all Docker volumes
      ansible.builtin.command: docker volume ls --format "{% raw %}{{.Name}}{% endraw %}"
      register: volume_list
      changed_when: false

    - name: Skip host if no volumes found
      ansible.builtin.meta: end_host
      when: volume_list.stdout_lines | length == 0

    - name: Filter out excluded volumes
      ansible.builtin.set_fact:
        volumes_to_backup: "{{ volume_list.stdout_lines | difference(volumes_to_exclude) }}"

    - name: Display volumes to backup
      ansible.builtin.debug:
        msg:
          - "==========================================="
          - "Docker Volumes Backup: {{ inventory_hostname }}"
          - "==========================================="
          - "Total volumes found: {{ volume_list.stdout_lines | length }}"
          - "Volumes to backup: {{ volumes_to_backup | length }}"
          - "Excluded volumes: {{ volumes_to_exclude | length }}"
          - ""
          - "Volumes: {{ volumes_to_backup | join(', ') }}"

    - name: Create backup directories for each volume
      ansible.builtin.file:
        path: "{{ backup_base_dir }}/{{ item }}"
        state: directory
        mode: '0755'
      loop: "{{ volumes_to_backup }}"
      become: true

    - name: Backup each volume using tar
      ansible.builtin.shell: |
        set -e
        docker run --rm \
          -v {{ item }}:/source:ro \
          -v {{ backup_base_dir }}/{{ item }}:/backup \
          alpine:latest \
          tar czf /backup/{{ item }}.tar.gz -C /source .
      args:
        executable: /bin/bash
      loop: "{{ volumes_to_backup }}"
      register: backup_results
      become: true

    #- name: Get backup file sizes
    #  ansible.builtin.find:
    #    paths: "{{ backup_base_dir }}"
    #    patterns: "*-{{ timestamp }}.tar.gz"
    #    recurse: true
    #  register: backup_files
    #  become: true

    #- name: Calculate total backup size
    #  ansible.builtin.set_fact:
    #    total_backup_size: "{{ backup_files.files | map(attribute='size') | sum }}"

    #- name: Display backup summary
    #  ansible.builtin.debug:
    #    msg:
    #      - "==========================================="
    #      - "Backup Complete: {{ inventory_hostname }}"
     #     - "==========================================="
    #      - "Backup location: {{ backup_base_dir }}/<volume_name>/"
    #      - "Volumes backed up: {{ volumes_to_backup | length }}"
    #      - "Total backup size: {{ (total_backup_size | int / 1024 / 1024) | round(2) }} MB"
    #      - ""
    #      - "Backup files:"
    #      - "{{ backup_files.files | map(attribute='path') | list | to_nice_yaml }}"
